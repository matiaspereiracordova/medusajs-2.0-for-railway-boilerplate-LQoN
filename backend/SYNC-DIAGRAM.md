# ๐ Diagrama de Sincronizaciรณn de Precios MedusaJS โ Odoo

## ๐ Flujo Visual Completo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        MEDUSAJS ADMIN PANEL                             โ
โ                                                                           โ
โ  Admin edita producto:                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ  โ Producto: Pantalรณn Cargo               โ                             โ
โ  โ โโโ Variante S: $29.990 CLP            โ                             โ
โ  โ โโโ Variante M: $31.990 CLP            โ                             โ
โ  โ โโโ Variante L: $33.990 CLP            โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ                        โ GUARDAR                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SUBSCRIBER (Automรกtico)                               โ
โ                 product-updated.ts                                       โ
โ                                                                           โ
โ  1. Detecta cambio โ event: 'product.updated'                           โ
โ  2. Verifica status: 'published' โ                                      โ
โ  3. Ejecuta sincronizaciรณn de estructura                                โ
โ  4. Espera 2 segundos                                                    โ
โ  5. Ejecuta sincronizaciรณn de precios                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    WORKFLOW: sync-prices-to-odoo                         โ
โ                 sync-prices-to-odoo-simple.ts                            โ
โ                                                                           โ
โ  Paso 1: Obtener productos con variantes y precios                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ  โ Product {                              โ                             โ
โ  โ   id: "prod_123"                       โ                             โ
โ  โ   variants: [                          โ                             โ
โ  โ     { sku: "PANT-S", prices: [...] }   โ                             โ
โ  โ     { sku: "PANT-M", prices: [...] }   โ                             โ
โ  โ     { sku: "PANT-L", prices: [...] }   โ                             โ
โ  โ   ]                                    โ                             โ
โ  โ }                                      โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ                           โ                                              โ
โ  Paso 2: Buscar producto en Odoo por x_medusa_id                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ  โ Odoo Product Template                  โ                             โ
โ  โ id: 45                                 โ                             โ
โ  โ x_medusa_id: "prod_123"                โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ                           โ                                              โ
โ  Paso 3: Calcular precio base (mรกs bajo)                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ  โ S: $29.990                             โ                             โ
โ  โ M: $31.990                             โ                             โ
โ  โ L: $33.990                             โ                             โ
โ  โ                                        โ                             โ
โ  โ โ Precio base: $29.990 โ              โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ                           โ                                              โ
โ  Paso 4: Actualizar precio base en Odoo                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ  โ product.template.list_price = $29.990  โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ                           โ                                              โ
โ  Paso 5: Para cada variante:                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ  โ Variante S:                            โ                             โ
โ  โ โโโ Buscar por SKU: "PANT-S"           โ                             โ
โ  โ โโโ list_price = $29.990               โ                             โ
โ  โ โโโ price_extra = $0                   โ                             โ
โ  โ     ($29.990 - $29.990)                โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                             โ
โ  โ Variante M:                            โ                             โ
โ  โ โโโ Buscar por SKU: "PANT-M"           โ                             โ
โ  โ โโโ list_price = $31.990               โ                             โ
โ  โ โโโ price_extra = $2.000               โ                             โ
โ  โ     ($31.990 - $29.990)                โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                             โ
โ  โ Variante L:                            โ                             โ
โ  โ โโโ Buscar por SKU: "PANT-L"           โ                             โ
โ  โ โโโ list_price = $33.990               โ                             โ
โ  โ โโโ price_extra = $4.000               โ                             โ
โ  โ     ($33.990 - $29.990)                โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                             ODOO (ERP)                                   โ
โ                                                                           โ
โ  product.template                                                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ  โ id: 45                                 โ                             โ
โ  โ name: "Pantalรณn Cargo"                 โ                             โ
โ  โ list_price: $29.990                    โ โ Precio base               โ
โ  โ x_medusa_id: "prod_123"                โ                             โ
โ  โ                                        โ                             โ
โ  โ Variantes (product.product):           โ                             โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ                             โ
โ  โ โ S - PANT-S                         โ โ                             โ
โ  โ โ list_price: $29.990                โ โ                             โ
โ  โ โ price_extra: $0                    โ โ                             โ
โ  โ โ โ Precio final: $29.990            โ โ                             โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ                             โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ                             โ
โ  โ โ M - PANT-M                         โ โ                             โ
โ  โ โ list_price: $31.990                โ โ                             โ
โ  โ โ price_extra: $2.000                โ โ                             โ
โ  โ โ โ Precio final: $31.990            โ โ                             โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ                             โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ                             โ
โ  โ โ L - PANT-L                         โ โ                             โ
โ  โ โ list_price: $33.990                โ โ                             โ
โ  โ โ price_extra: $4.000                โ โ                             โ
โ  โ โ โ Precio final: $33.990            โ โ                             โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                             โ
โ                                                                           โ
โ  โ SINCRONIZACIรN COMPLETA                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Mรฉtodos de Sincronizaciรณn

### 1. Automรกtico (Subscriber)
```
โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ
โ   Admin    โ         โ Subscriber โ         โ    Odoo    โ
โ   Panel    โโโโโโโโโโถโ  product-  โโโโโโโโโโถโ    ERP     โ
โ            โ update  โ  updated   โ  sync   โ            โ
โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ
     โ                       โ                       โ
  Guardar              Detecta cambio           Actualiza
  producto             Auto-sincroniza          precios
                       (2s delay)
```

### 2. Job Programado
```
โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ
โ   Cron     โ         โ    Job     โ         โ    Odoo    โ
โ  6 horas   โโโโโโโโโโถโ Scheduled  โโโโโโโโโโถโ    ERP     โ
โ            โ trigger โ            โ  sync   โ            โ
โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ
     โ                       โ                       โ
  Ejecuta              Procesa 50              Actualiza
  cada 6h              productos               precios
```

### 3. API Manual
```
โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ
โ   Admin/   โ         โ    API     โ         โ    Odoo    โ
โ   Script   โโโโโโโโโโถโ  Endpoint  โโโโโโโโโโถโ    ERP     โ
โ            โ  POST   โ            โ  sync   โ            โ
โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ         โโโโโโโโโโโโโโ
     โ                       โ                       โ
  Ejecuta              Procesa segรบn           Actualiza
  cuando quieras       parรกmetros              precios
```

---

## ๐ Arquitectura de Precios

### Estructura en MedusaJS
```
Product
โโโ variants[]
    โโโ id: "variant_001"
    โโโ sku: "PANT-S"
    โโโ title: "S"
    โโโ prices[]
        โโโ {
        โ    amount: 2999000,    // En centavos
        โ    currency_code: "clp",
        โ    region_id: "reg_cl"
        โ  }
        โโโ {
             amount: 30,         // En USD
             currency_code: "usd",
             region_id: "reg_us"
           }
```

### Transformaciรณn a Odoo
```
MedusaJS                          Odoo
โโโโโโโโโโโโโโโโโโโโโโ           โโโโโโโโโโโโโโโโโโโโโโ
amount: 2999000 centavos    โ    list_price: 29990
currency: "clp"             โ    currency: CLP
sku: "PANT-S"              โ    default_code: "PANT-S"
variant.prices[0]          โ    price_extra: calculado
```

### Fรณrmulas
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Precio Base (product.template)             โ
โ                                             โ
โ list_price = MIN(todos_los_precios)        โ
โ                                             โ
โ Ejemplo:                                    โ
โ MIN($29.990, $31.990, $33.990) = $29.990   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Precio Extra (product.product)             โ
โ                                             โ
โ price_extra = precio_variante - precio_baseโ
โ                                             โ
โ Ejemplos:                                   โ
โ S: $29.990 - $29.990 = $0                  โ
โ M: $31.990 - $29.990 = $2.000              โ
โ L: $33.990 - $29.990 = $4.000              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Precio Final en Odoo                        โ
โ                                             โ
โ precio_final = list_price + price_extra     โ
โ                                             โ
โ Ejemplos:                                   โ
โ S: $29.990 + $0     = $29.990              โ
โ M: $29.990 + $2.000 = $31.990              โ
โ L: $29.990 + $4.000 = $33.990              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Timeline de Sincronizaciรณn

### Flujo Completo (Subscriber)
```
0s    โ Admin edita producto en MedusaJS
      โ โ
0.1s  โ Event 'product.updated' emitido
      โ โ
0.2s  โ Subscriber detecta cambio
      โ โ
0.5s  โ Inicia sync-to-odoo (estructura)
      โ โโโ Sincroniza producto
      โ โโโ Crea/actualiza variantes
      โ โโโ Configura atributos
      โ โ
2.5s  โ Espera 2 segundos (delay)
      โ โ
3s    โ Inicia sync-prices-to-odoo
      โ โโโ Busca producto en Odoo
      โ โโโ Calcula precio base
      โ โโโ Actualiza template.list_price
      โ โโโ Para cada variante:
      โ     โโโ Busca por SKU
      โ     โโโ Actualiza list_price
      โ     โโโ Calcula price_extra
      โ โ
5s    โ โ Sincronizaciรณn completa
      โ
      โ Resultado en Odoo:
      โ โ Producto actualizado
      โ โ Precio base correcto
      โ โ Variantes con precios
      โ โ Price extra calculado
```

---

## ๐ฏ Casos de Uso Visualizados

### Caso 1: Nuevo Producto
```
Paso 1: Crear producto en MedusaJS
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Crear "Polera Bรกsica"           โ
โ โโโ Variante S: $19.990         โ
โ โโโ Variante M: $19.990         โ
โ โโโ Variante L: $21.990         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ Guardar
         
Paso 2: Sincronizar estructura
POST /admin/sync-to-odoo
         โ
         
Paso 3: Sincronizar precios
POST /admin/sync-prices-to-odoo
         โ
         
Resultado en Odoo:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Polera Bรกsica                   โ
โ Precio base: $19.990            โ
โ โโโ S: $19.990 (extra: $0)     โ
โ โโโ M: $19.990 (extra: $0)     โ
โ โโโ L: $21.990 (extra: $2.000) โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Caso 2: Actualizar Precio
```
Estado Inicial en MedusaJS:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Pantalรณn Cargo                  โ
โ โโโ Variante M: $31.990         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Admin cambia precio:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Pantalรณn Cargo                  โ
โ โโโ Variante M: $29.990 โ๏ธ      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ Guardar
         
Subscriber automรกtico:
         โ
         
Resultado en Odoo:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Pantalรณn Cargo                  โ
โ โโโ M: $29.990 โ (actualizado) โ
โ โโโ price_extra: recalculado    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Monitoreo Visual

### Logs Exitosos
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฆ SUBSCRIBER: Producto detectado
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ Sincronizando estructura...
โ Producto sincronizado
โ Variantes creadas: 3
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ Sincronizando precios...
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Precio base: $29.990 CLP
โ Variant S: $29.990 (extra: $0)
โ Variant M: $31.990 (extra: $2.000)
โ Variant L: $33.990 (extra: $4.000)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ Sincronizaciรณn completa
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Dashboard de Mรฉtricas
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   SINCRONIZACIรN DE PRECIOS           โ
โ   รltima ejecuciรณn: Hace 2h           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ                                       โ
โ   ๐ Productos procesados:      50    โ
โ   โ Variantes sincronizadas:   150   โ
โ   ๐ฐ Precios actualizados:      150   โ
โ   โ Errores:                   0     โ
โ                                       โ
โ   โฐ Prรณxima ejecuciรณn: 4h           โ
โ                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Deploy en Railway

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   RAILWAY DEPLOYMENT                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Step 1: Git Push
โโโโโโโโโโ
โ  Git   โ  git push origin main
โโโโโโฌโโโโ
     โ
Step 2: Railway Build
โโโโโโโโโโ
โ Build  โ  npm run build
โโโโโโฌโโโโ
     โ
Step 3: Deploy
โโโโโโโโโโ
โ Deploy โ  pnpm run start
โโโโโโฌโโโโ
     โ
Step 4: Post-Deploy
โโโโโโโโโโโโโโโ
โ Post-Deploy โ  railway-post-deploy.js
โโโโโโโฌโโโโโโโโ
      โโโ โ Seed (primera vez)
      โโโ โน๏ธ Info sobre price sync
      
Step 5: Server Running
โโโโโโโโโโโโโโโโ
โ MedusaJS     โ  ๐ Server started
โ + Job Active โ  โฐ Job scheduled
โโโโโโโโโโโโโโโโ
      โ
      Cada 6 horas โ Sync automรกtico โ
      Admin update โ Sync automรกtico โ
      API manual   โ Disponible โ
```

---

**Este diagrama muestra el flujo completo de sincronizaciรณn de precios**
**desde MedusaJS hacia Odoo, con todos los mรฉtodos disponibles.**

